<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- Content Security Policy for enhanced security -->
    <meta http-equiv="Content-Security-Policy" content="
        default-src 'self';
        script-src 'self' 'unsafe-inline' https://cdn.jsdelivr.net https://cdnjs.cloudflare.com https://code.jquery.com;
        style-src 'self' 'unsafe-inline' https://cdn.jsdelivr.net https://cdnjs.cloudflare.com https://fonts.googleapis.com;
        font-src 'self' https://fonts.gstatic.com https://cdnjs.cloudflare.com;
        img-src 'self' data:;
        connect-src 'self';
        frame-src 'none';
        base-uri 'self';
        form-action 'none';
    ">
    <title>Novel Reader - HTML File Processor</title>

    <!-- Fallback styles loaded first -->
    <style>
        .fallback-msg { display: none; position: fixed; top: 0; left: 0; right: 0; background: #ffebee; color: #c62828; text-align: center; padding: 10px; z-index: 9999; }
        .js-disabled .fallback-msg { display: block; }
        .loading::after { content: ''; display: inline-block; width: 16px; height: 16px; border: 2px solid #f3f3f3; border-top: 2px solid #007bff; border-radius: 50%; animation: spin 1s linear infinite; margin-left: 8px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>

    <!-- External dependencies with integrity checks and fallbacks -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet"
          integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN"
          crossorigin="anonymous" onerror="this.onerror=null; loadFallback('../css/bootstrap-fallback.css')">

    <link rel="preconnect" href="https://fonts.googleapis.com" crossorigin>
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&family=Source+Serif+4:ital,wght@0,400;0,600;1,400&display=swap"
          rel="stylesheet" onerror="this.onerror=null; loadFallbackFont()">

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css"
          integrity="sha384-ZTfMH8Xz/rmFScagTTGQCsqmwAM+J8VaAeHyESgNxhkskOVsGn8Jrf4urGYYwK9J"
          crossorigin="anonymous" onerror="this.onerror=null; loadFallback('../css/fontawesome-fallback.css')">

    <!-- DOMPurify for XSS protection -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dompurify/3.0.6/purify.min.js"
            integrity="sha384-QcDKJzsMpqqCwkMhKsM8J3Vsu8YXLTwjEbUTgGxDMlT68GN1iZjJQz6ltpVBFOcx"
            crossorigin="anonymous"></script>

    <!-- Custom styles -->
    <link rel="stylesheet" href="reader.css">
</head>
<body>
    <noscript>
        <div style="text-align: center; padding: 2rem; font-family: sans-serif; background: #ffebee; color: #c62828; min-height: 100vh;">
            <h2 style="margin-bottom: 1rem;">JavaScript Required</h2>
            <p>This application requires JavaScript to function. Please enable JavaScript in your browser settings and reload the page.</p>
        </div>
    </noscript>

    <!-- Fallback message for loading issues -->
    <div id="fallbackMsg" class="fallback-msg">
        Some external resources failed to load. The app will work with reduced functionality.
    </div>

    <div class="novel-reader theme-light font-serif" id="novelReader">
        <!-- Upload Screen -->
        <div id="uploadSection" class="container-fluid">
            <h1 class="text-center mt-4 mb-4">Novel Reader</h1>

            <div class="file-upload-area" id="fileUploadArea">
                <i class="fas fa-cloud-upload-alt" aria-hidden="true"></i>
                <h3>Drop HTML Novel File Here</h3>
                <p class="text-muted">Or click to browse and select a file</p>
                <input type="file" id="fileInput" accept=".html,.htm" aria-label="Upload novel file">
            </div>

            <div class="progress-container" id="uploadProgress">
                <div class="progress-bar">
                    <div class="progress-bar bg-success" id="progressBar" style="width: 0%"></div>
                </div>
                <p class="text-center mt-2" id="progressText">Processing file...</p>
            </div>
        </div>

        <!-- Reader Interface (hidden initially) -->
        <div id="readerSection" class="hidden">
            <!-- Header Controls -->
            <header class="reader-header" role="banner">
                <nav class="reader-controls" aria-label="Reader navigation">
                    <div role="group" aria-label="Navigation controls">
                        <button class="btn-control" id="sidebarToggle" aria-label="Toggle table of contents">
                            <i class="fas fa-bars" aria-hidden="true"></i>
                        </button>
                        <button class="btn-control" id="prevChapter" aria-label="Previous chapter">
                            <i class="fas fa-chevron-left" aria-hidden="true"></i>
                        </button>
                        <button class="btn-control" id="nextChapter" aria-label="Next chapter">
                            <i class="fas fa-chevron-right" aria-hidden="true"></i>
                        </button>
                    </div>

                    <div class="flex-grow-1 text-center">
                        <span id="chapterTitle" class="fw-bold" role="heading" aria-level="1"></span>
                        <div class="chapter-progress" id="chapterProgress">
                            <div class="progress mt-1" role="progressbar" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">
                                <div class="progress-bar" id="chapterProgressBar" style="width: 0%;"></div>
                            </div>
                        </div>
                    </div>

                    <div role="group" aria-label="Settings and actions">
                        <button class="btn-control" id="exportBtn" aria-label="Export novel" title="Export Novel">
                            <i class="fas fa-download" aria-hidden="true"></i>
                        </button>
                        <button class="btn-control dropdown-toggle" data-bs-toggle="dropdown" aria-label="Settings" title="Settings">
                            <i class="fas fa-cog" aria-hidden="true"></i>
                        </button>
                        <ul class="dropdown-menu dropdown-menu-end" role="menu">
                            <li role="none"><h6 class="dropdown-header">Theme</h6></li>
                            <li role="none"><a class="dropdown-item" href="#" data-theme="light" role="menuitem">Light</a></li>
                            <li role="none"><a class="dropdown-item" href="#" data-theme="dark" role="menuitem">Dark</a></li>
                            <li role="none"><a class="dropdown-item" href="#" data-theme="sepia" role="menuitem">Sepia</a></li>
                            <li role="none" class="dropdown-divider"></li>
                            <li role="none"><h6 class="dropdown-header">Font</h6></li>
                            <li role="none"><a class="dropdown-item" href="#" data-font="serif" role="menuitem">Serif</a></li>
                            <li role="none"><a class="dropdown-item" href="#" data-font="sans" role="menuitem">Sans</a></li>
                            <li role="none"><a class="dropdown-item" href="#" data-font="mono" role="menuitem">Monospace</a></li>
                            <li role="none" class="dropdown-divider"></li>
                            <li role="none"><h6 class="dropdown-header">Font Size</h6></li>
                            <li role="none">
                                <div class="d-flex align-items-center px-3">
                                    <span class="me-2" id="fontSizeLabel">18px</span>
                                    <input type="range" class="form-range flex-grow-1" id="fontSizeSlider"
                                           min="12" max="24" value="18" aria-label="Font size adjustment">
                                </div>
                            </li>
                        </ul>
                    </div>
                </nav>
            </header>

            <!-- Main Reading Area -->
            <main class="reader-main">
                <!-- Table of Contents Sidebar -->
                <aside class="reader-sidebar" id="sidebar" aria-label="Table of contents">
                    <div class="p-3">
                        <h5 class="mb-3">Table of Contents</h5>
                        <nav aria-label="Chapters">
                            <ul class="chapter-list" id="chapterList" role="list">
                                <!-- Chapters will be populated here -->
                            </ul>
                        </nav>
                    </div>
                </aside>

                <!-- Content Area -->
                <div class="reader-content-area">
                    <div class="reader-content" id="chapterContent" role="main" tabindex="0">
                        <!-- Chapter content will be displayed here -->
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"
            integrity="sha384-C6RzsynM9kWDrMNeT87bh95OGNyZPhcTNXj1NW7RuBCsyN/o0jlpcV8Qyq46cDfL"
            crossorigin="anonymous"></script>

    <!-- Application JavaScript -->
    <script src="reader.js"></script>

    <script>
        // Fallback functions for external resource failures
        function loadFallback(href) {
            const link = document.createElement('link');
            link.rel = 'stylesheet';
            link.href = href;
            document.head.appendChild(link);
            document.getElementById('fallbackMsg').classList.add('show');
        }

        function loadFallbackFont() {
            // Fallback web fonts or system fonts
            document.documentElement.style.setProperty('--reader-font-family', 'serif');
            document.getElementById('fallbackMsg').classList.add('show');
        }

        // Check if DOMPurify loaded
        if (typeof DOMPurify === 'undefined') {
            alert('Security library failed to load. Some features may not work properly.\nPlease refresh the page or check your connection.');
        }
    </script>
</body>
</html>
